{% extends 'base.html' %}
{% load static humanize %}

{% block title %}Farmers List{% endblock %}

{% block content %}
<div class="card shadow p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Farmers {% if selected_season %} {{ selected_season.year }} Growing Season 
            {% else %} All Seasons{% endif %}</h2>
        <!-- Season Filter -->
        <form method="get" class="d-flex">
            <select name="season" class="form-select me-2" onchange="this.form.submit()">
                {% for s in seasons %}
                    <option value="{{ s.id }}" {% if s.id == selected_season.id %}selected{% endif %}>
                        {{ s.year }}
                    </option>
                {% endfor %}
            </select>
            <noscript><button type="submit" class="btn btn-primary">Filter</button></noscript>
        </form>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-3" id="farmerTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="billed-tab" data-bs-toggle="tab" data-bs-target="#billed" type="button" role="tab">Billed Items</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="not-billed-tab" data-bs-toggle="tab" data-bs-target="#not-billed" type="button" role="tab">Not Billed Items</button>
        </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="farmerTabsContent">
        <!-- Billed Items Tab -->
        <div class="tab-pane fade show active" id="billed" role="tabpanel">
            <div class="table-responsive mb-4">
                <table class="table table-striped table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Crop</th>
                            <th>Acres</th>
                            <th>Item</th>
                            <th>Category</th>
                            <th>Quantity</th>
                            <th>Unit</th>
                            <th>Market Cost</th>
                            <th>Total Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for data in farmer_data %}
                            {% if data.billed_distributions %}
                                {% for dist in data.billed_distributions %}
                                <tr>
                                    {% if forloop.first %}
                                    <td rowspan="{{ data.billed_distributions|length }}">{{ data.farmer.name }}</td>
                                    {% endif %}
                                    <td>{{ dist.farmer_crop.crop.name }}</td>
                                    <td>{{ dist.farmer_crop.acres }}</td>
                                    <td>{{ dist.input_item.name }}</td>
                                    <td>{{ dist.input_item.category.name }}</td>
                                    <td>{{ dist.quantity }}</td>
                                    <td>{{ dist.input_item.unit }}</td>
                                    <td>MK {{ dist.input_item.market_cost|floatformat:2|intcomma }}</td>
                                    <td>MK {{ dist.total_cost|floatformat:2|intcomma }}</td>
                                </tr>
                                {% endfor %}
                                <!-- Per Farmer Total -->
                                <tr class="table-secondary fw-bold">
                                    <td colspan="8" class="text-end">Total for {{ data.farmer.name }}</td>
                                    <td>MK {{ data.total_billed|floatformat:2|intcomma }}</td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="9" class="text-center">No billed items available for {{ data.farmer.name }}.</td>
                                </tr>
                            {% endif %}
                        {% empty %}
                            <tr>
                                <td colspan="9" class="text-center">No farmers available for season {{ selected_season.year }}.</td>
                            </tr>
                        {% endfor %}
                        <!-- Gross Total -->
                        <tr class="table-dark text-white fw-bold">
                            <td colspan="8" class="text-end">Gross Total</td>
                            <td>MK {{ total_billed_all|floatformat:2|intcomma }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Per Crop Totals -->
            <h5>Per Crop Total (Billed)</h5>
            <table class="table table-bordered table-striped mb-4">
                <thead class="table-light">
                    <tr>
                        <th>Crop</th>
                        <th>Total Quantity (KG)</th>
                        <th>Total Cost (MK)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for crop_name, crop_total in billed_crop_totals.items %}
                    <tr>
                        <td>{{ crop_name }}</td>
                        <td>{{ crop_total.quantity|floatformat:2|intcomma }}</td>
                        <td>MK {{ crop_total.total_cost|floatformat:2|intcomma }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Not Billed Items Tab -->
        <div class="tab-pane fade" id="not-billed" role="tabpanel">
            <div class="table-responsive mb-4">
                <table class="table table-striped table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Crop</th>
                            <th>Acres</th>
                            <th>Item</th>
                            <th>Category</th>
                            <th>Quantity</th>
                            <th>Unit</th>
                            <th>Market Cost</th>
                            <th>Total Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for data in farmer_data %}
                            {% if data.not_billed_distributions %}
                                {% for dist in data.not_billed_distributions %}
                                <tr>
                                    {% if forloop.first %}
                                    <td rowspan="{{ data.not_billed_distributions|length }}">{{ data.farmer.name }}</td>
                                    {% endif %}
                                    <td>{{ dist.farmer_crop.crop.name }}</td>
                                    <td>{{ dist.farmer_crop.acres }}</td>
                                    <td>{{ dist.input_item.name }}</td>
                                    <td>{{ dist.input_item.category.name }}</td>
                                    <td>{{ dist.quantity }}</td>
                                    <td>{{ dist.input_item.unit }}</td>
                                    <td>MK {{ dist.input_item.market_cost|floatformat:2|intcomma }}</td>
                                    <td>MK {{ dist.total_cost|floatformat:2|intcomma }}</td>
                                </tr>
                                {% endfor %}
                                <!-- Per Farmer Total -->
                                <tr class="table-secondary fw-bold">
                                    <td colspan="8" class="text-end">Total for {{ data.farmer.name }}</td>
                                    <td>MK {{ data.total_not_billed|floatformat:2|intcomma }}</td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="9" class="text-center">No not billed items available for {{ data.farmer.name }}.</td>
                                </tr>
                            {% endif %}
                        {% empty %}
                            <tr>
                                <td colspan="9" class="text-center">No farmers available for season {{ selected_season.year }}.</td>
                            </tr>
                        {% endfor %}
                        <!-- Gross Total -->
                        <tr class="table-dark text-white fw-bold">
                            <td colspan="8" class="text-end">Gross Total</td>
                            <td>MK {{ total_not_billed_all|floatformat:2|intcomma }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Per Crop Totals -->
            <h5>Per Crop Total (Not Billed)</h5>
            <table class="table table-bordered table-striped mb-4">
                <thead class="table-light">
                    <tr>
                        <th>Crop</th>
                        <th>Total Quantity (KG)</th>
                        <th>Total Cost (MK)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for crop_name, crop_total in not_billed_crop_totals.items %}
                    <tr>
                        <td>{{ crop_name }}</td>
                        <td>{{ crop_total.quantity|floatformat:2|intcomma }}</td>
                        <td>MK {{ crop_total.total_cost|floatformat:2|intcomma }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="mt-3">
        <a href="{% url 'farmer_create' %}" class="btn btn-success">âž• Add Farmer</a>
        <a href="{% url 'summary' %}" class="btn btn-info">ðŸ“Š Summary</a>
    </div>
</div>
{% endblock %}
